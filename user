package com.rwtool.service;

import com.rwtool.model.UserNotification;
import com.rwtool.model.UserGroup;
import com.rwtool.repository.UserNotificationRepository;
import com.rwtool.repository.UserGroupRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.HashSet;
import java.util.List;
import java.util.Set;

@Service
public class NotificationService {

    @Autowired
    private UserNotificationRepository notificationRepository;

    @Autowired
    private UserGroupRepository userGroupRepository;

    public List<UserNotification> getUserNotifications(String userEmail) {
        return notificationRepository.findByUserEmailOrderByCreatedAtDesc(userEmail);
    }

    public List<UserNotification> getUnreadNotifications(String userEmail) {
        return notificationRepository
                .findByUserEmailOrderByCreatedAtDesc(userEmail)
                .stream()
                .filter(n -> !n.isRead())
                .toList();
    }

    public long countUnread(String userEmail) {
        return notificationRepository.countByUserEmailAndReadIsFalse(userEmail);
    }

    @Transactional
    public void markAllAsRead(String userEmail) {
        List<UserNotification> list = notificationRepository.findByUserEmailOrderByCreatedAtDesc(userEmail);
        for (UserNotification n : list) {
            if (!n.isRead()) {
                n.setRead(true);
            }
        }
        notificationRepository.saveAll(list);
    }

    @Transactional
    public void clearForUser(String userEmail) {
        notificationRepository.deleteByUserEmail(userEmail);
    }

    @Transactional
    public void notifyUsersFileSent(String folder, String fileName) {
        // Find all group members who have access to this folder
        Set<String> recipients = new HashSet<>();
        List<UserGroup> groups = userGroupRepository.findAll();
        for (UserGroup g : groups) {
            if (g.getFolderAccess() != null && g.getFolderAccess().contains(folder)) {
                if (g.getMembers() != null) {
                    recipients.addAll(g.getMembers());
                }
            }
        }

        if (recipients.isEmpty()) return;

        String title = "New Report Available";
        String message = "A new file '" + fileName + "' was added to domain '" + folder + "'.";
        String sourceId = (folder + ":" + fileName).toLowerCase();

        for (String email : recipients) {
            // avoid duplicate for same source
            if (notificationRepository.findBySourceId(sourceId).isPresent()) continue;

            UserNotification n = new UserNotification();
            n.setUserEmail(email);
            n.setType(UserNotification.Type.file);
            n.setTitle(title);
            n.setMessage(message);
            n.setSourceId(sourceId);
            n.setRead(false);
            notificationRepository.save(n);
        }
    }
}


